<?php
defined( 'ABSPATH' ) || exit;

get_header( 'shop' );

// Robust product object initialization following WooCommerce best practices
$product = null;

// First, try to get the global product object if it exists
if ( isset($GLOBALS['product']) && is_a($GLOBALS['product'], 'WC_Product') ) {
    $product = $GLOBALS['product'];
} else {
    // If global is not valid, initialize it properly
    $product_id = get_the_ID();
    
    // Validate we have a proper product ID and post type
    if ( $product_id && is_numeric($product_id) && get_post_type($product_id) === 'product' ) {
        $product = wc_get_product($product_id);
        
        // Validate the product object was created successfully
        if ( is_a($product, 'WC_Product') ) {
            $GLOBALS['product'] = $product;
        } else {
            error_log('ERROR: wc_get_product() failed for ID ' . $product_id . '. Returned: ' . print_r($product, true));
            $product = null;
        }
    } else {
        error_log('ERROR: Invalid product context. ID: ' . $product_id . ', Post type: ' . get_post_type($product_id));
    }
} ?>

<div class="page-shell">
    <section class="hero">
        <article class="gallery-card">
            <div class="badge-stack">
                <?php
                // Display product badges (sale, featured, etc.)
                $badges = array();
                
                // Only proceed with badge logic if we have a valid product object
                if ( $product && is_a($product, 'WC_Product') ) {
                    // Check if product is on sale
                    if ( $product->is_on_sale() ) {
                        $badges[] = array( 'text' => 'Limited Drop', 'type' => 'sale' );
                    }
                    
                    // Check if product is featured
                    if ( $product->is_featured() ) {
                        $badges[] = array( 'text' => 'Editors\' Pick', 'type' => 'featured' );
                    }
                } else {
                    error_log('WARNING: Cannot display product badges - invalid product object');
                }
                
                // Add more badge logic as needed
                
                if ( !empty($badges) ) {
                    foreach ( $badges as $badge ) {
                        echo '<span class="badge"><span class="dot"></span>' . esc_html($badge['text']) . '</span>';
                    }
                }
                ?>
            </div>
            <div class="main-image">
                <?php
                // Use the simplified gallery component that matches the concept design
                get_template_part( 'template-parts/components/product-gallery-simple' );
                ?>
            </div>
            <div class="thumb-strip">
                <!-- Thumbnails will be generated by WooCommerce gallery component -->
            </div>
        </article>

        <aside class="details-panel">
            <?php if ( $product && is_a($product, 'WC_Product') ) : ?>
                <!-- Collection Tag -->
                <span class="collection-tag">
                    <?php
                    // Get the first product category as collection tag
                    $terms = get_the_terms( $product->get_id(), 'product_cat' );
                    if ( $terms && !is_wp_error( $terms ) ) {
                        echo esc_html( $terms[0]->name );
                    } else {
                        echo 'AW25 Capsule';
                    }
                    ?>
                </span>
                
                <!-- Product Title -->
                <h1 class="product-title"><?php echo esc_html( $product->get_name() ); ?></h1>
                
                <!-- Product Subtitle/Description -->
                <?php if ( $product->get_short_description() ) : ?>
                    <div class="subtitle wc-short-description">
                        <?php
                        // Render WooCommerce short description allowing expected HTML instead of escaping tags
                        echo apply_filters( 'woocommerce_short_description', $product->get_short_description() );
                        ?>
                    </div>
                <?php endif; ?>

                <!-- Price Row -->
                <div class="price-row">
                    <?php woocommerce_template_single_price(); ?>
                </div>

                <!-- Options Block (Colors, Sizes, etc.) -->
                <div class="options-block">
                    <?php
                    // Product variations (colors, sizes, etc.)
                    if ( $product->is_type('variable') ) {
                        // Display variable product attributes in concept design style
                        $attributes = $product->get_variation_attributes();
                        if ( !empty($attributes) ) {
                            echo '<div class="variation-selects">';
                            foreach ( $attributes as $attribute_name => $attribute ) {
                                $attribute_id = wc_attribute_taxonomy_id_by_name( $attribute_name );
                                $attribute_label = wc_attribute_label( str_replace( 'attribute_', '', $attribute_name ), $product );
                                
                                echo '<div class="variation-select">';
                                echo '<span class="block-label">' . esc_html( $attribute_label ) . '</span>';
                                
                                // Get terms for this attribute
                                $terms = wp_get_post_terms( $product->get_id(), str_replace( 'attribute_', '', $attribute_name ) );
                                if ( $terms && !is_wp_error( $terms ) ) {
                                    if ( strpos( $attribute_name, 'color' ) !== false || strpos( $attribute_name, 'colour' ) !== false ) {
                                        // Color swatches
                                        echo '<div class="color-palette">';
                                        foreach ( $terms as $term ) {
                                            $color_code = get_term_meta( $term->term_id, 'color_code', true );
                                            echo '<button class="swatch" type="button" data-attribute="' . esc_attr( $attribute_name ) . '" data-value="' . esc_attr( $term->slug ) . '">';
                                            if ( $color_code ) {
                                                echo '<span class="tone" style="background: ' . esc_attr( $color_code ) . ';"></span>';
                                            }
                                            echo '<span class="swatch-name">' . esc_html( $term->name ) . '</span>';
                                            echo '</button>';
                                        }
                                        echo '</div>';
                                    } else {
                                        // Size or other select
                                        echo '<div class="size-grid">';
                                        foreach ( $terms as $term ) {
                                            echo '<button class="size-tile" type="button" data-attribute="' . esc_attr( $attribute_name ) . '" data-value="' . esc_attr( $term->slug ) . '">' . esc_html( $term->name ) . '</button>';
                                        }
                                        echo '</div>';
                                    }
                                }
                                echo '</div>';
                            }
                            echo '</div>';
                        }
                        
                        // Stock availability for variable products
                        if ( $product->get_manage_stock() ) {
                            echo '<div class="availability">';
                            echo '<span class="stock-badge">In Stock</span>';
                            echo '<span class="stock-copy">Available in multiple sizes</span>';
                            echo '</div>';
                        }
                        
                        // Add to cart button for variable products
                        echo '<div class="variable-add-to-cart">';
                        woocommerce_single_variation_add_to_cart_button();
                        echo '</div>';
                    }
                    
                    // Simple product add to cart
                    if ( $product->is_type('simple') ) {
                        echo '<div class="simple-add-to-cart">';
                        woocommerce_simple_add_to_cart();
                        echo '</div>';
                    }
                    ?>
                </div>

                <!-- CTA Row intentionally removed to prevent duplicate quantity/add-to-cart blocks.
                     Wishlist buttons are included inside the add-to-cart templates
                     (simple.php and variation-add-to-cart-button.php). -->

                <!-- Note Banner -->
                <div class="note-banner">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 8v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
                    </svg>
                    Ships within 48 hours from Athens with carbon-neutral delivery.
                </div>

                <!-- Detail Accordions -->
                <div class="detail-accordions">
                    <div class="detail-accordion">
                        <button class="detail-accordion-trigger" type="button" aria-expanded="true">
                            <span>Shipping & Returns</span>
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6 9l6 6 6-6"></path>
                                </svg>
                            </span>
                        </button>
                        <div class="detail-accordion-panel">
                            <p>Complimentary carbon-neutral delivery across Greece within 2 business days. EU orders arrive in 3–5 days.</p>
                            <p>We offer free exchanges within 30 days. Returns remain effortless—use the enclosed prepaid label or visit a Walking Company boutique.</p>
                        </div>
                    </div>

                    <div class="detail-accordion">
                        <button class="detail-accordion-trigger" type="button" aria-expanded="false">
                            <span>Payment Options</span>
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6 9l6 6 6-6"></path>
                                </svg>
                            </span>
                        </button>
                        <div class="detail-accordion-panel" hidden>
                            <p>Secure checkout supports Visa, Mastercard, Amex, and Apple Pay. Klarna instalments are available for purchases above €180.</p>
                            <p>Your card is only charged once the pair leaves our atelier.</p>
                        </div>
                    </div>
                </div>
            <?php else : ?>
                <div class="error-message">
                    <p><?php _e('Product information is currently unavailable. Please try again later.', 'eshop-theme'); ?></p>
                </div>
            <?php endif; ?>
        </aside>
    </section>

    <?php
        /**
         * Hook: woocommerce_after_single_product_summary.
         *
         * @hooked woocommerce_output_product_data_tabs - 10
         * @hooked woocommerce_upsell_display - 15
         * @hooked woocommerce_output_related_products - 20
         */
        do_action( 'woocommerce_after_single_product_summary' );
    ?>
</div>

<!-- Accordion JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const triggers = document.querySelectorAll('.detail-accordion-trigger');

    triggers.forEach(function (trigger) {
        trigger.addEventListener('click', function () {
            const expanded = trigger.getAttribute('aria-expanded') === 'true';
            const panel = trigger.nextElementSibling;

            trigger.setAttribute('aria-expanded', String(!expanded));

            if (panel) {
                if (expanded) {
                    panel.setAttribute('hidden', '');
                } else {
                    panel.removeAttribute('hidden');
                }
            }
        });
    });
});
</script>

<?php get_footer( 'shop' );